// +build gen

package main

import (
	"bytes"
	"go/format"
	"html/template"
	"io/ioutil"
	"log"

	"github.com/pkg/errors"
	"golang.org/x/tools/go/packages"
)

//go:generate go run -tags gen ./...

const (
	fileName = "../package_list.go"

	fileTemplate = `// Code generated by ./gen/gen.go DO NOT EDIT.
package std

// StdPackages is a set of go libs
var StdPackages = map[string]struct{}{
{{- range $index, $element := .}}
	"{{$element}}": {},
{{- end}}
}

`
)

var experimentalPackageList = []string{
	"syscall/js",
}

func main() {
	w := bytes.NewBufferString("")

	tpl := template.New("tpl")
	tpl, err := tpl.Parse(fileTemplate)
	if err != nil {
		log.Fatalf("%+v", errors.WithStack(err))
		return
	}

	packageList, err := packages.Load(nil, "std")
	if err != nil {
		log.Fatalf("%+v", errors.WithStack(err))
		return
	}

	for _, experimentalPackage := range experimentalPackageList {
		packageList = append(packageList, &packages.Package{
			ID: experimentalPackage,
		})
	}

	if err := tpl.Execute(w, packageList); err != nil {
		log.Fatalf("%+v", errors.WithStack(err))
		return
	}

	data, err := format.Source(w.Bytes())
	if err != nil {
		log.Fatalf("%+v", errors.WithStack(err))
		return
	}

	if err := ioutil.WriteFile(fileName, data, 0644); err != nil {
		log.Fatalf("%+v", errors.WithStack(err))
	}
}
